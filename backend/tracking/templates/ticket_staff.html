<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestion Tickets ‚Äî Staff</title>
  <style>
    /* Palette sobre et contrast√©e pour usage sous pression */
    :root {
      --bg: #f6f8fb;
      --card: #ffffff;
      --accent: #2563eb;
      --accent-2: #06b6d4;
      --warn: #f59e0b;
      --danger: #ef4444;
      --success: #16a34a;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 14px 36px rgba(15, 23, 42, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 18px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(37,99,235,0.08), rgba(6,182,212,0.10));
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
    }
    .title { font-size: 22px; font-weight: 800; margin: 0; }
    .subtitle { color: var(--muted); font-size: 13px; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--muted);
      font-weight: 600;
      box-shadow: var(--shadow);
    }
    .pill .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--muted); }
    .pill.green .dot { background: var(--success); }
    .pill.red .dot { background: var(--danger); }
    .controls { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    main { padding: 20px; display: grid; gap: 16px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap: 12px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .card h2 { margin: 0 0 8px; font-size: 16px; display: flex; align-items: center; gap: 6px; }
    .card small { color: var(--muted); }
    .now-serving {
      display: grid;
      place-items: center;
      text-align: center;
      padding: 18px;
      background: linear-gradient(135deg, rgba(37,99,235,0.10), rgba(6,182,212,0.12));
      border: 1px solid rgba(37,99,235,0.16);
      border-radius: 18px;
      box-shadow: var(--shadow);
    }
    .now-label { color: var(--muted); font-weight: 700; letter-spacing: 0.5px; }
    .now-ticket { font-size: 48px; font-weight: 900; margin: 6px 0; }
    .now-time { color: var(--muted); font-size: 14px; }
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 10px; }
    .kpi {
      border-radius: 12px;
      padding: 12px;
      background: #f8fafc;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .kpi .label { color: var(--muted); font-size: 13px; font-weight: 600; }
    .kpi .value { font-size: 26px; font-weight: 800; margin-top: 2px; }
    .kpi .sub { color: var(--muted); font-size: 12px; }
    .queue-list { display: flex; flex-direction: column; gap: 8px; }
    .queue-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      box-shadow: var(--shadow);
    }
    .queue-item .ticket {
      width: 42px; height: 42px; border-radius: 10px;
      display: grid; place-items: center;
      font-weight: 800; color: var(--accent);
      background: rgba(37,99,235,0.10);
    }
    .queue-item .meta { color: var(--muted); font-size: 12px; }
    .queue-item .pill-mini {
      padding: 4px 8px; border-radius: 999px; font-size: 11px; font-weight: 700;
      background: rgba(37,99,235,0.12); color: var(--accent);
    }
    .queue-item .pill-mini.waiting { background: rgba(37,99,235,0.12); }
    .queue-item .pill-mini.in_progress { background: rgba(22,163,74,0.14); color: var(--success); }
    .queue-item .pill-mini.completed { background: rgba(100,116,139,0.14); color: #475569; }

    .actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 10px; }
    .btn {
      padding: 12px 14px;
      border-radius: 12px;
      border: none;
      font-weight: 800;
      cursor: pointer;
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow);
      transition: transform 120ms ease, box-shadow 120ms ease, opacity 120ms ease;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }
    .btn.green { background: linear-gradient(135deg, #16a34a, #22c55e); }
    .btn.blue { background: linear-gradient(135deg, #2563eb, #06b6d4); }
    .btn.amber { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: #111827; }
    .btn.red { background: linear-gradient(135deg, #ef4444, #f87171); }

    .redis-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 10px; }
    .redis-card {
      border: 1px dashed var(--accent);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(37,99,235,0.06);
      color: #0f172a;
      box-shadow: var(--shadow);
      font-size: 14px;
    }
    .redis-card strong { color: var(--accent); }
    .status-text { color: var(--muted); font-size: 13px; }
    .toast {
      position: fixed; top: 20px; right: 20px;
      padding: 12px 14px; border-radius: 12px;
      color: #fff; background: #111827;
      box-shadow: 0 12px 30px rgba(0,0,0,0.2);
      opacity: 0; transform: translateY(-8px);
      transition: opacity 160ms ease, transform 160ms ease;
      z-index: 100;
      font-weight: 700;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: #16a34a; }
    .toast.warn { background: #f59e0b; color: #111827; }
    .toast.info { background: #2563eb; }

    .modal {
      position: fixed; inset: 0;
      background: rgba(15,23,42,0.45);
      display: grid; place-items: center;
      z-index: 200;
      opacity: 0; pointer-events: none;
      transition: opacity 120ms ease;
    }
    .modal.show { opacity: 1; pointer-events: auto; }
    .modal-content {
      background: #fff;
      border-radius: 16px;
      padding: 18px;
      width: min(420px, 90vw);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 14px; }
    footer { text-align: center; padding: 14px 16px 22px; color: var(--muted); font-size: 13px; }

    @media (max-width: 720px) { header { flex-direction: column; align-items: flex-start; } }
  </style>
</head>
<body>
  <div id="toast" class="toast"></div>
  <div id="modal-confirm" class="modal">
    <div class="modal-content">
      <h3 style="margin:0 0 8px;">Fin de journ√©e</h3>
      <div class="status-text">Cette action vide la file et r√©initialise les cl√©s du jour. Confirmer ?</div>
      <div class="modal-actions">
        <button class="btn blue" id="confirm-cancel">Annuler</button>
        <button class="btn red" id="confirm-yes">Confirmer</button>
      </div>
    </div>
  </div>

  <header>
    <div>
      <div class="title">Gestion des tickets (Staff)</div>
      <div class="status-text" id="status-text">En attente...</div>
    </div>
    <div class="controls">
      <div class="pill" id="pill-date">üìÖ <span id="today-date"></span></div>
      <div class="pill" id="pill-open"><span class="dot"></span><span id="service-status">-</span></div>
      <div class="pill" id="pill-redis"><span class="dot"></span>Redis en direct</div>
    </div>
  </header>

  <main>
    <div class="card">
      <h2>Ticket en cours</h2>
      <div class="now-serving">
        <div class="now-label">En cours</div>
        <div class="now-ticket" id="now-ticket">-</div>
        <div class="now-time" id="now-time">--:--</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Contr√¥les</h2>
        <div class="actions">
          <button class="btn green" id="btn-start">‚ñ∂Ô∏è D√©marrer la journ√©e</button>
          <button class="btn blue" id="btn-call">üîî Appeler le suivant</button>
          <button class="btn amber" id="btn-finish">‚úÖ Cl√¥turer le ticket</button>
          <button class="btn red" id="btn-end">‚èπÔ∏è Terminer la journ√©e</button>
        </div>
      </div>
      <div class="card">
        <h2>Vue file</h2>
        <div class="kpi-grid">
          <div class="kpi">
            <div class="label">Suivant</div>
            <div class="value" id="kpi-next">-</div>
          </div>
          <div class="kpi">
            <div class="label">En attente</div>
            <div class="value" id="kpi-waiting">-</div>
            <div class="sub">Personnes dans la file</div>
          </div>
          <div class="kpi">
            <div class="label">Total du jour</div>
            <div class="value" id="kpi-total">-</div>
          </div>
          <div class="kpi">
            <div class="label">Attente moyenne</div>
            <div class="value" id="kpi-avg">-</div>
            <div class="sub">Bas√© sur la file</div>
          </div>
        </div>
        <div class="queue-list" id="queue-list" style="margin-top:10px;">
          <div class="status-text">Chargement...</div>
        </div>
      </div>
    </div>
  </main>

  <footer>Interface staff temps r√©el</footer>

  <script>
    // S√©paration JS pour clart√© : fetch snapshot, binder actions, afficher Redis en direct.
    const statusText = document.getElementById("status-text");
    const toastEl = document.getElementById("toast");
    const modal = document.getElementById("modal-confirm");
    const confirmYes = document.getElementById("confirm-yes");
    const confirmCancel = document.getElementById("confirm-cancel");

    const btnStart = document.getElementById("btn-start");
    const btnCall = document.getElementById("btn-call");
    const btnFinish = document.getElementById("btn-finish");
    const btnEnd = document.getElementById("btn-end");

    const nowTicketEl = document.getElementById("now-ticket");
    const nowTimeEl = document.getElementById("now-time");
    const kpiNext = document.getElementById("kpi-next");
    const kpiWaiting = document.getElementById("kpi-waiting");
    const kpiTotal = document.getElementById("kpi-total");
    const kpiAvg = document.getElementById("kpi-avg");
    const queueList = document.getElementById("queue-list");

    const pillDate = document.getElementById("today-date");
    const pillOpen = document.getElementById("pill-open");
    const serviceStatus = document.getElementById("service-status");
    const pillRedis = document.getElementById("pill-redis");

    const redisQueue = document.getElementById("redis-queue");
    const redisHash = document.getElementById("redis-hash");
    const redisKeys = document.getElementById("redis-keys");
    const redisTtl = document.getElementById("redis-ttl");

    const fmtTime = (iso) => {
      if (!iso) return "--:--";
      try { return new Date(iso).toLocaleString("fr-FR", { timeZone: "Africa/Tunis" }); } catch (e) { return iso; }
    };
    const fmtSeconds = (s) => {
      if (s == null) return "-";
      const m = Math.floor(s / 60);
      const sec = Math.round(s % 60);
      return `${m}m ${sec}s`;
    };
    function toast(msg, type="info") {
      toastEl.textContent = msg;
      toastEl.className = "toast show " + type;
      setTimeout(() => toastEl.classList.remove("show"), 2000);
    }
    function setStatus(text) { statusText.textContent = text; }

    const audioEl = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YRAAAAAg//8A//8A//8A//8A//8A//8A//8A//8A");
    function playTone() { try { audioEl.currentTime = 0; audioEl.play(); } catch (e) {} }
    function speakTicket(num) {
      if (!num) return;
      try {
        const utter = new SpeechSynthesisUtterance(`Ticket num√©ro ${num}`);
        utter.lang = "fr-FR"; utter.rate = 1;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utter);
      } catch (e) {}
    }
    function speakWelcome() {
      try {
        const utter = new SpeechSynthesisUtterance("Bonjour, le service est ouvert");
        utter.lang = "fr-FR"; utter.rate = 1;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utter);
      } catch (e) {}
    }

    let pollTimer = null;
    async function fetchSnapshot() {
      setStatus("Chargement...");
      const data = await fetch("/api/tickets/snapshot").then(r => r.json());
      render(data);
      setStatus("Mis √† jour : " + new Date().toLocaleTimeString());
    }

    function render(data) {
      const isOpen = data.open !== false;
      const cur = isOpen ? (data.current_ticket_data || {}) : {};
      nowTicketEl.textContent = isOpen ? (data.current_ticket ?? "‚Äî") : "Ferm√©";
      nowTimeEl.textContent = isOpen ? fmtTime(cur.creation_time_iso ?? cur.creation_time) : "--:--";

      kpiNext.textContent = isOpen ? (data.next_ticket ?? "‚Äî") : "‚Äî";
      kpiWaiting.textContent = isOpen ? (data.waiting_tickets ?? 0) : 0;
      kpiTotal.textContent = isOpen ? (data.total_tickets ?? 0) : 0;
      kpiAvg.textContent = fmtSeconds(data.avg_wait_seconds);

      serviceStatus.textContent = isOpen ? "Ouvert" : "Ferm√©";
      pillOpen.classList.remove("green", "red");
      pillOpen.classList.add(isOpen ? "green" : "red");
      pillRedis.classList.remove("green", "red");
      pillRedis.classList.add("green");
      pillDate.textContent = new Date().toLocaleDateString("fr-FR", { weekday: "long", day: "2-digit", month: "long" });

      // queue top 5
      const list = isOpen ? (data.waiting_list || []) : [];
      queueList.innerHTML = "";
      if (!isOpen) {
        queueList.innerHTML = '<div class="status-text">Service ferm√©.</div>';
      } else if (!list.length) {
        queueList.innerHTML = '<div class="status-text">Aucun ticket en attente.</div>';
      } else {
        list.slice(0,5).forEach(item => {
          const status = item.status || "waiting";
          queueList.innerHTML += `
            <div class="queue-item">
              <div style="display:flex; align-items:center; gap:10px;">
                <div class="ticket">${item.ticket_number ?? "-"}</div>
                <div>
                  <div style="font-weight:700;">Ticket #${item.ticket_number ?? "-"}</div>
                  <div class="meta">${fmtTime(item.creation_time_iso ?? item.creation_time)}</div>
                </div>
              </div>
              <div class="pill-mini ${status}">${status.replace("_"," ")}</div>
            </div>`;
        });
      }

      // Redis transparency
      if (redisQueue) redisQueue.textContent = data.waiting_tickets ?? 0;
      if (redisHash) redisHash.textContent = data.hash_count ?? 0;
      if (redisKeys) redisKeys.textContent = data.key_count ?? 0;
      if (redisTtl) redisTtl.textContent = data.ttl_seconds ? fmtSeconds(data.ttl_seconds) : "-";

      // Buttons state
      btnStart.disabled = isOpen;
      btnEnd.disabled = !isOpen;
      btnCall.disabled = !isOpen;
      btnFinish.disabled = !isOpen;
    }

    async function postAction(url, onSuccessMsg, onAfter) {
      try {
        const res = await fetch(url, { method: "POST" });
        const json = await res.json();
        if (onSuccessMsg) toast(onSuccessMsg, "info");
        if (onAfter) onAfter(json);
        await fetchSnapshot();
      } catch (e) {
        console.error(e);
        toast("Erreur action", "warn");
      }
    }

    // End day confirmation modal
    btnEnd.addEventListener("click", () => { modal.classList.add("show"); });
    confirmCancel.addEventListener("click", () => modal.classList.remove("show"));
    confirmYes.addEventListener("click", async () => {
      modal.classList.remove("show");
      await postAction("/api/tickets/end-day", "Journ√©e termin√©e");
    });

    btnStart.addEventListener("click", async () => {
      await postAction("/api/tickets/start-day", "Journ√©e d√©marr√©e");
      speakWelcome();
    });
    btnCall.addEventListener("click", async () => {
      await postAction("/api/tickets/call-next", "Ticket appel√©", (json) => {
        if (json.current_ticket) { playTone(); speakTicket(json.current_ticket); }
      });
    });
    btnFinish.addEventListener("click", async () => {
      await postAction("/api/tickets/finish-current", "Ticket cl√¥tur√©");
    });

    function startPolling() {
      stopPolling();
      fetchSnapshot();
      pollTimer = setInterval(fetchSnapshot, 2000);
    }
    function stopPolling() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = null;
    }

    startPolling();
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) stopPolling(); else startPolling();
    });
  </script>
</body>
</html>
